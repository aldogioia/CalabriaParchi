<form [formGroup]="galleryItemForm" (ngSubmit)="submit()">
  <h3>Aggiungi una nuova Foto</h3>

  <div class="input-group" [class.error]="isInvalid('parkId')">
    <label for="park">Parco</label>
    <select name="park" [class.color]="galleryItemForm.value.park === ''" formControlName="parkId" required>
      <option value="" disabled selected>Seleziona un Parco</option>
      @for (park of parks; track park) {
        <option [value]="park.id">{{ park.name }}</option>
      }
    </select>
    @if (isInvalid('parkId')) {
      <span class="error-message">{{ getErrorMessage('parkId') }}</span>
    }
  </div>

  <div class="input-group" [class.error]="(!galleryItemToModify ? galleryItemForm.invalid  || !selectedFile : galleryItemForm.invalid) && galleryItemForm.touched">
    <label for="img">Foto</label>
    <div class="file-wrapper">
      <input #fileInput id="img" name="img" type="file" (change)="onFileSelected($event)" required>
    </div>
    @if ((!galleryItemToModify ? galleryItemForm.invalid  || !selectedFile : galleryItemForm.invalid) && galleryItemForm.touched) {
      <span class="error-message">Immagine obbligatoria</span>
    }
  </div>

  <div class="input-group" [class.error]="isInvalid('description')">
    <label for="description">Descrizione</label>
    <input name="description" type="text" maxlength="80" placeholder="Descrizione" formControlName="description" required>
    @if (isInvalid('description')) {
      <span class="error-message">{{ getErrorMessage('description') }}</span>
    }
  </div>

  <div class="input-group" [class.error]="isInvalid('englishDescription')">
    <label for="en_description">Descrizione Inglese</label>
    <input name="en_description" type="text" maxlength="80" placeholder="Descrizione in Inglese" formControlName="englishDescription" required>
    @if (isInvalid('englishDescription')) {
      <span class="error-message">{{ getErrorMessage('englishDescription') }}</span>
    }
  </div>

  <button
    class="primary-button"
    type="submit"
    [disabled]="!galleryItemToModify ? galleryItemForm.invalid  || !selectedFile : galleryItemForm.invalid">
    {{ galleryItemToModify ? "Modifica" : "Aggiungi" }}
  </button>

  <div class="row">
    <button class="tertiary-button" type="reset" (click)="resetForm()">
      Annulla
    </button>

    @if (galleryItemToModify) {
      <button class="tertiary-button error" type="reset" (click)="deletePark()">
        Elimina
      </button>
    }
  </div>
</form>

<section>
  <div class="sub-section">
    <h4>Anteprima</h4>
    <div class="box">
      <figure>
        @if (selectedFileUrl) {
          <img [src]="selectedFileUrl" alt="Anteprima immagine">
        } @else {
          <div class="background">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="24" width="24">
              <path d="M3.77 20.87C5.38 22.25 7.59 22.25 12 22.25C16.4 22.25 18.62 22.25 20.23 20.87C20.48 20.66 20.69 20.46 20.87 20.24C22.25 18.62 22.25 16.41 22.25 12C22.25 7.59 22.25 5.38001 20.87 3.76001C20.69 3.55001 20.48 3.34 20.23 3.13C18.62 1.75 16.4 1.75 12 1.75C7.6 1.75 5.38 1.75 3.77 3.13C3.52 3.34 3.31 3.54001 3.13 3.76001C1.75 5.38001 1.75 7.58999 1.75 12V12V12C1.75 16.41 1.75 18.62 3.13 20.24C3.31 20.45 3.52 20.66 3.77 20.87ZM4.74 4.27002C5.93 3.25002 7.96 3.25 12 3.25C16.04 3.25 18.07 3.25002 19.26 4.27002C19.43 4.41002 19.59 4.55998 19.73 4.72998C20.75 5.92998 20.75 7.95999 20.75 11.99C20.75 13.0057 20.75 13.8943 20.7337 14.6746L19.0599 13.0009C18.0999 12.0309 16.3999 12.0309 15.4399 13.0009L13.9999 14.4409L10.5599 11.0009C9.59994 10.0309 7.89994 10.0309 6.93994 11.0009L3.26612 14.6747C3.25 13.8968 3.25 13.0114 3.25 12V12V12C3.25 7.96999 3.25 5.93999 4.27 4.73999C4.41 4.56999 4.57 4.41002 4.74 4.27002ZM3.3731 16.6505C3.42939 16.6185 3.48224 16.5787 3.52994 16.531L7.99994 12.061C8.39994 11.661 9.09994 11.661 9.49994 12.061L14.9699 17.531C15.1199 17.681 15.3099 17.7509 15.4999 17.7509C15.6899 17.7509 15.8799 17.681 16.0299 17.531C16.3199 17.241 16.3199 16.7609 16.0299 16.4709L15.0599 15.5009L16.4999 14.061C16.8999 13.661 17.5999 13.661 17.9999 14.061L20.4699 16.531C20.5174 16.5784 20.5699 16.6181 20.6259 16.65C20.4995 17.828 20.2446 18.6446 19.73 19.25C19.59 19.42 19.43 19.58 19.26 19.72C18.07 20.74 16.04 20.74 12 20.74C7.96 20.74 5.93 20.74 4.74 19.72C4.57 19.58 4.41 19.43 4.27 19.26C3.75406 18.653 3.49909 17.8337 3.3731 16.6505ZM15.5 8.75C16.1904 8.75 16.75 8.19036 16.75 7.5C16.75 6.80964 16.1904 6.25 15.5 6.25C14.8096 6.25 14.25 6.80964 14.25 7.5C14.25 8.19036 14.8096 8.75 15.5 8.75Z" />
            </svg>
          </div>
        }
        <figcaption>{{ galleryItemForm.get('description')?.value || 'Descrizione immagine' }}</figcaption>
      </figure>
    </div>
  </div>
  <div class="sub-section">
    <h4>Parchi gi√† presenti</h4>
    @if (galleryItemForm.get('parkId')?.value === '') {
      <p>Selezionare prima un parco.</p>
    } @else if (galleryItems.length === 0) {
      <p>Nessuna immagine presente per questo parco.</p>
    } @else {
      <div class="box">
        @for (galleryItem of galleryItems; track galleryItem.id) {
          <ng-container *ngTemplateOutlet="galleryItemTemplate; context: { $implicit: galleryItem }"></ng-container>
        }
      </div>
    }
  </div>
</section>

<ng-template #galleryItemTemplate let-galleryItemDto>
  <figure [class.modifying]="galleryItemToModify?.id === galleryItemDto.id">
    <img [src]="galleryItemDto.imageUrl" alt="Anteprima immagine">
    <figcaption>{{ galleryItemDto.description }}</figcaption>
    @if (galleryItemToModify?.id !== galleryItemDto.id) {
      <button class="secondary-button" (click)="selectGalleryItem(galleryItemDto)">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M20.95,3.05 C22.017,4.117 22.017,5.847 20.95,6.914 L14.314,13.55 L14.234,13.631 C13.265,14.599 12.673,15.191 11.945,15.598 C11.538,15.825 10.922,16.024 10.291,16.199 C9.642,16.38 8.895,16.558 8.182,16.728 L8.174,16.73 C7.92,16.79 7.654,16.715 7.47,16.53 C7.286,16.346 7.21,16.08 7.27,15.826 L7.272,15.818 C7.442,15.105 7.62,14.358 7.801,13.709 C7.976,13.078 8.175,12.462 8.402,12.055 C8.809,11.327 9.401,10.735 10.369,9.766 L10.37,9.766 L10.45,9.686 L17.086,3.05 C18.153,1.983 19.883,1.983 20.95,3.05 Z M12,2.25 C12.414,2.25 12.75,2.586 12.75,3 C12.75,3.414 12.414,3.75 12,3.75 C9.857,3.75 8.326,3.752 7.162,3.908 C6.02,4.062 5.345,4.352 4.848,4.848 C4.352,5.345 4.062,6.02 3.908,7.162 C3.752,8.326 3.75,9.857 3.75,12 C3.75,14.142 3.752,15.674 3.908,16.838 C4.062,17.98 4.352,18.655 4.848,19.152 C5.345,19.648 6.02,19.938 7.162,20.092 C8.326,20.248 9.857,20.25 12,20.25 C14.142,20.25 15.674,20.248 16.838,20.092 C17.98,19.938 18.655,19.648 19.152,19.152 C19.648,18.655 19.938,17.98 20.092,16.838 C20.248,15.674 20.25,14.142 20.25,12 C20.25,11.586 20.586,11.25 21,11.25 C21.414,11.25 21.75,11.586 21.75,12 L21.75,12.057 C21.75,14.13 21.75,15.762 21.579,17.038 C21.403,18.346 21.034,19.391 20.212,20.212 C19.391,21.034 18.346,21.403 17.038,21.579 C15.762,21.75 14.13,21.75 12.057,21.75 L11.943,21.75 C9.87,21.75 8.238,21.75 6.962,21.579 C5.654,21.403 4.609,21.034 3.788,20.212 C2.966,19.391 2.597,18.346 2.421,17.038 C2.25,15.762 2.25,14.13 2.25,12.057 L2.25,11.943 C2.25,9.87 2.25,8.238 2.421,6.962 C2.597,5.654 2.966,4.609 3.788,3.788 C4.609,2.966 5.654,2.597 6.962,2.421 C8.238,2.25 9.87,2.25 11.943,2.25 Z M16.214,6.043 L11.511,10.747 C10.436,11.821 10.005,12.262 9.711,12.787 C9.582,13.017 9.424,13.471 9.246,14.111 C9.17,14.385 9.094,14.678 9.018,14.982 C9.322,14.906 9.615,14.83 9.889,14.754 C10.529,14.576 10.983,14.418 11.213,14.289 C11.738,13.995 12.179,13.564 13.253,12.489 L17.957,7.786 Z M18.146,4.111 L17.275,4.982 L19.018,6.725 L19.889,5.854 C20.37,5.373 20.37,4.592 19.889,4.111 C19.408,3.63 18.628,3.63 18.146,4.111 Z" />
        </svg>
      </button>
    }
  </figure>
</ng-template>
